(.venv) PS C:\pycharm\fastapi-hexagonal-async> pytest
C:\pycharm\fastapi-hexagonal-async\.venv\lib\site-packages\pytest_asyncio\plugin.py:217: PytestDeprecationWarning: The configuration option "asyncio_default_fixture_loop_scope" is unset.
The event loop scope for asynchronous fixtures will default to the fixture caching scope. Future versions of pytest-asyncio will default the loop scope for asynchronous fixtures to function scope. Set the default fixture loop scope explicitly in order to avoid unexpected behavior in the future. Valid fixture loop scopes are: "function", "class", "module", "package", "session"

  warnings.warn(PytestDeprecationWarning(_DEFAULT_FIXTURE_LOOP_SCOPE_UNSET))
....F......F...FF...........................................                                                                                                                 [100%]
==================================================================================== FAILURES ===================================================================================== 
______________________________________________________________________ test_content_type_create_update_cycle ______________________________________________________________________ 
app\adapters\outbound\persistence\repositories\content_type_repository.py:215: in update
    return content_type.to_domain()
app\adapters\outbound\persistence\models\user_group\auth_content_type.py:64: in to_domain
    for perm in self.permissions
.venv\lib\site-packages\sqlalchemy\orm\attributes.py:566: in __get__
    return self.impl.get(state, dict_)  # type: ignore[no-any-return]
.venv\lib\site-packages\sqlalchemy\orm\attributes.py:1086: in get
    value = self._fire_loader_callables(state, key, passive)
.venv\lib\site-packages\sqlalchemy\orm\attributes.py:1121: in _fire_loader_callables
    return self.callable_(state, passive)
.venv\lib\site-packages\sqlalchemy\orm\strategies.py:978: in _load_for_state
    return self._emit_lazyload(
.venv\lib\site-packages\sqlalchemy\orm\strategies.py:1141: in _emit_lazyload
    result = session.execute(
.venv\lib\site-packages\sqlalchemy\orm\session.py:2365: in execute
    return self._execute_internal(
.venv\lib\site-packages\sqlalchemy\orm\session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv\lib\site-packages\sqlalchemy\orm\context.py:306: in orm_execute_statement
    result = conn.execute(
.venv\lib\site-packages\sqlalchemy\engine\base.py:1416: in execute
    return meth(
.venv\lib\site-packages\sqlalchemy\sql\elements.py:523: in _execute_on_connection
    return connection._execute_clauseelement(
.venv\lib\site-packages\sqlalchemy\engine\base.py:1638: in _execute_clauseelement
    ret = self._execute_context(
.venv\lib\site-packages\sqlalchemy\engine\base.py:1843: in _execute_context
    return self._exec_single_context(
.venv\lib\site-packages\sqlalchemy\engine\base.py:1983: in _exec_single_context
    self._handle_dbapi_exception(
.venv\lib\site-packages\sqlalchemy\engine\base.py:2355: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
.venv\lib\site-packages\sqlalchemy\engine\base.py:1964: in _exec_single_context
    self.dialect.do_execute(
.venv\lib\site-packages\sqlalchemy\engine\default.py:945: in do_execute
    cursor.execute(statement, parameters)
.venv\lib\site-packages\sqlalchemy\dialects\postgresql\asyncpg.py:580: in execute
    self._adapt_connection.await_(
.venv\lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:123: in await_only
    raise exc.MissingGreenlet(
E   sqlalchemy.exc.MissingGreenlet: greenlet_spawn has not been called; can't call await_only() here. Was IO attempted in an unexpected place? (Background on this error at: https://sqlalche.me/e/20/xd2s)

During handling of the above exception, another exception occurred:
app\test\integration\test_content_type_operations.py:54: in test_content_type_create_update_cycle
    updated_ct = await service.update_content_type(
app\application\use_cases\content_type_use_cases.py:174: in update_content_type
    return await content_type_repository.update(self.db, content_type_id, current_content_type)
app\adapters\outbound\persistence\repositories\content_type_repository.py:221: in update
    raise DatabaseOperationException(
E   app.domain.exceptions.DatabaseOperationException: Error updating content type with ID 29: greenlet_spawn has not been called; can't call await_only() here. Was IO attempted in an unexpected place? (Background on this error at: https://sqlalche.me/e/20/xd2s)
_________________________________________________________________________ test_transaction_commit_success _________________________________________________________________________ 
app\test\integration\test_transaction_integrity.py:138: in test_transaction_commit_success
    updated_user1 = result.scalars().one()
.venv\lib\site-packages\sqlalchemy\engine\result.py:1808: in one
    return self._only_one_row(
.venv\lib\site-packages\sqlalchemy\engine\result.py:776: in _only_one_row
    existing_row_hash = strategy(row) if strategy else row
.venv\lib\site-packages\sqlalchemy\orm\loading.py:285: in require_unique
    raise sa_exc.InvalidRequestError(
E   sqlalchemy.exc.InvalidRequestError: The unique() method must be invoked on this Result, as it contains results that include joined eager loads against collections
_________________________________________________________________________ test_add_remove_user_to_groups __________________________________________________________________________ 
app\application\use_cases\user_group_use_cases.py:366: in remove_user_from_groups
    groups_to_remove = (await self.db.execute(stmt)).scalars().all()
.venv\lib\site-packages\sqlalchemy\engine\result.py:1767: in all
    return self._allrows()
.venv\lib\site-packages\sqlalchemy\engine\result.py:562: in _allrows
    for made_row, sig_row in [
.venv\lib\site-packages\sqlalchemy\engine\result.py:565: in <listcomp>
    strategy(made_row) if strategy else made_row,
.venv\lib\site-packages\sqlalchemy\orm\loading.py:285: in require_unique
    raise sa_exc.InvalidRequestError(
E   sqlalchemy.exc.InvalidRequestError: The unique() method must be invoked on this Result, as it contains results that include joined eager loads against collections

During handling of the above exception, another exception occurred:
app\test\integration\test_user_group_associations.py:68: in test_add_remove_user_to_groups
    updated_user = await user_group_service.remove_user_from_groups(superuser, test_user.id, remove_data)
app\application\use_cases\user_group_use_cases.py:382: in remove_user_from_groups
    raise DatabaseOperationException(message="Error removing user from groups", original_error=e)
E   app.domain.exceptions.DatabaseOperationException: Error removing user from groups: The unique() method must be invoked on this Result, as it contains results that include joined eager loads against collections
------------------------------------------------------------------------------ Captured stderr call ------------------------------------------------------------------------------- 
2025-05-19 18:29:41,501 INFO app.application.use_cases.group_use_cases: Group 'test-group1-55038d9d-ffad-426b-a051-1c4f111d6801' created by usertest-2edbaaf2-a36f-4df7-b9e3-92c722cb5d95@example.com
2025-05-19 18:29:41,501 INFO app.application.use_cases.group_use_cases: Group 'test-group2-3f040b0a-3390-40a9-830c-6d3af740466b' created by usertest-2edbaaf2-a36f-4df7-b9e3-92c722cb5d95@example.com
2025-05-19 18:29:41,519 INFO app.application.use_cases.user_group_use_cases: User b35c9900-d009-4c52-85b9-9844a3d6876e added to groups [56, 57] by usertest-2edbaaf2-a36f-4df7-b9e3-92c722cb5d95@example.com
2025-05-19 18:29:41,533 ERROR app.application.use_cases.user_group_use_cases: Error removing user from groups: The unique() method must be invoked on this Result, as it contains results that include joined eager loads against collections
Traceback (most recent call last):
  File "C:\pycharm\fastapi-hexagonal-async\app\application\use_cases\user_group_use_cases.py", line 366, in remove_user_from_groups
    groups_to_remove = (await self.db.execute(stmt)).scalars().all()
  File "C:\pycharm\fastapi-hexagonal-async\.venv\lib\site-packages\sqlalchemy\engine\result.py", line 1767, in all
    return self._allrows()
  File "C:\pycharm\fastapi-hexagonal-async\.venv\lib\site-packages\sqlalchemy\engine\result.py", line 562, in _allrows
    for made_row, sig_row in [
  File "C:\pycharm\fastapi-hexagonal-async\.venv\lib\site-packages\sqlalchemy\engine\result.py", line 565, in <listcomp>
    strategy(made_row) if strategy else made_row,
  File "C:\pycharm\fastapi-hexagonal-async\.venv\lib\site-packages\sqlalchemy\orm\loading.py", line 285, in require_unique
    raise sa_exc.InvalidRequestError(
sqlalchemy.exc.InvalidRequestError: The unique() method must be invoked on this Result, as it contains results that include joined eager loads against collections
-------------------------------------------------------------------------------- Captured log call -------------------------------------------------------------------------------- 
INFO     app.application.use_cases.group_use_cases:group_use_cases.py:107 Group 'test-group1-55038d9d-ffad-426b-a051-1c4f111d6801' created by usertest-2edbaaf2-a36f-4df7-b9e3-92c722cb5d95@example.com
INFO     app.application.use_cases.group_use_cases:group_use_cases.py:107 Group 'test-group2-3f040b0a-3390-40a9-830c-6d3af740466b' created by usertest-2edbaaf2-a36f-4df7-b9e3-92c722cb5d95@example.com
INFO     app.application.use_cases.user_group_use_cases:user_group_use_cases.py:112 User b35c9900-d009-4c52-85b9-9844a3d6876e added to groups [56, 57] by usertest-2edbaaf2-a36f-4df7-b9e3-92c722cb5d95@example.com
ERROR    app.application.use_cases.user_group_use_cases:user_group_use_cases.py:381 Error removing user from groups: The unique() method must be invoked on this Result, as it contains results that include joined eager loads against collections
Traceback (most recent call last):
  File "C:\pycharm\fastapi-hexagonal-async\app\application\use_cases\user_group_use_cases.py", line 366, in remove_user_from_groups
    groups_to_remove = (await self.db.execute(stmt)).scalars().all()
  File "C:\pycharm\fastapi-hexagonal-async\.venv\lib\site-packages\sqlalchemy\engine\result.py", line 1767, in all
    return self._allrows()
  File "C:\pycharm\fastapi-hexagonal-async\.venv\lib\site-packages\sqlalchemy\engine\result.py", line 562, in _allrows
    for made_row, sig_row in [
  File "C:\pycharm\fastapi-hexagonal-async\.venv\lib\site-packages\sqlalchemy\engine\result.py", line 565, in <listcomp>
    strategy(made_row) if strategy else made_row,
  File "C:\pycharm\fastapi-hexagonal-async\.venv\lib\site-packages\sqlalchemy\orm\loading.py", line 285, in require_unique
    raise sa_exc.InvalidRequestError(
sqlalchemy.exc.InvalidRequestError: The unique() method must be invoked on this Result, as it contains results that include joined eager loads against collections
_________________________________________________________________________ test_user_effective_permissions _________________________________________________________________________ 
app\test\integration\test_user_group_associations.py:128: in test_user_effective_permissions
    assert len(user_permissions.group_permissions) > 0
.venv\lib\site-packages\pydantic\main.py:994: in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E   AttributeError: 'UserPermissionOutput' object has no attribute 'group_permissions'. Did you mean: 'direct_permissions'?
------------------------------------------------------------------------------ Captured stderr call ------------------------------------------------------------------------------- 
2025-05-19 18:29:42,313 INFO app.application.use_cases.group_use_cases: Group 'perm-group-041d1638-e41e-4641-888d-b4f220b16fd0' created by usertest-3721a478-7a85-471d-9fa2-cf74729f39ac@example.com
2025-05-19 18:29:42,313 INFO app.application.use_cases.group_use_cases: Permissions [1, 2] added to group 58 by usertest-3721a478-7a85-471d-9fa2-cf74729f39ac@example.com
2025-05-19 18:29:42,345 INFO app.application.use_cases.user_group_use_cases: User e007b7f7-90b0-40b8-96bc-21dc0a775583 added to groups [58] by usertest-3721a478-7a85-471d-9fa2-cf74729f39ac@example.com
2025-05-19 18:29:42,362 INFO app.application.use_cases.user_group_use_cases: Direct permissions [3] added to user e007b7f7-90b0-40b8-96bc-21dc0a775583 by usertest-3721a478-7a85-471d-9fa2-cf74729f39ac@example.com
-------------------------------------------------------------------------------- Captured log call -------------------------------------------------------------------------------- 
INFO     app.application.use_cases.group_use_cases:group_use_cases.py:107 Group 'perm-group-041d1638-e41e-4641-888d-b4f220b16fd0' created by usertest-3721a478-7a85-471d-9fa2-cf74729f39ac@example.com
INFO     app.application.use_cases.group_use_cases:group_use_cases.py:292 Permissions [1, 2] added to group 58 by usertest-3721a478-7a85-471d-9fa2-cf74729f39ac@example.com
INFO     app.application.use_cases.user_group_use_cases:user_group_use_cases.py:112 User e007b7f7-90b0-40b8-96bc-21dc0a775583 added to groups [58] by usertest-3721a478-7a85-471d-9fa2-cf74729f39ac@example.com
INFO     app.application.use_cases.user_group_use_cases:user_group_use_cases.py:244 Direct permissions [3] added to user e007b7f7-90b0-40b8-96bc-21dc0a775583 by usertest-3721a478-7a85-471d-9fa2-cf74729f39ac@example.com
============================================================================= short test summary info ============================================================================= 
FAILED app/test/integration/test_content_type_operations.py::test_content_type_create_update_cycle - app.domain.exceptions.DatabaseOperationException: Error updating content type with ID 29: greenlet_spawn has not been called; can't call await_only() here. Was IO attempted in...
FAILED app/test/integration/test_transaction_integrity.py::test_transaction_commit_success - sqlalchemy.exc.InvalidRequestError: The unique() method must be invoked on this Result, as it contains results that include joined eager loads against collections
FAILED app/test/integration/test_user_group_associations.py::test_add_remove_user_to_groups - app.domain.exceptions.DatabaseOperationException: Error removing user from groups: The unique() method must be invoked on this Result, as it contains results that include join...
FAILED app/test/integration/test_user_group_associations.py::test_user_effective_permissions - AttributeError: 'UserPermissionOutput' object has no attribute 'group_permissions'. Did you mean: 'direct_permissions'?
4 failed, 56 passed, 1 warning in 34.26s
(.venv) PS C:\pycharm\fastapi-hexagonal-async>
